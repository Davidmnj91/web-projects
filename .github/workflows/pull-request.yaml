name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write

jobs:
  changeset:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for changeset
        id: check_changeset
        run: |
          labels="${{ toJson(github.event.pull_request.labels) }}"
          title="${{ github.event.pull_request.title }}"

          # bypass if label exists
          if echo "$labels" | grep -q '"name": *"no-changeset-needed"'; then
            echo "status=bypass" >> $GITHUB_OUTPUT
            exit 0
          fi

          # bypass if PR title starts with chore: or docs:
          if echo "$title" | grep -Eiq '^(chore|docs)'; then
            echo "status=bypass" >> $GITHUB_OUTPUT
            exit 0
          fi

          # check for changeset
          if git diff --name-only origin/${{ github.base_ref }} | grep -q '^.changeset/.*\.md$'; then
            echo "status=found" >> $GITHUB_OUTPUT
          else
            echo "status=missing" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Manage PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = "${{ steps.check_changeset.outputs.status }}";
            const issue_number = context.issue.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
            });

            const botComments = comments.filter(c =>
              c.user.type === "Bot" &&
              c.body.includes("This PR is missing a **Changeset**")
            );

            if (status === "missing") {
              if (botComments.length === 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number,
                  body: "⚠️ This PR is missing a **Changeset**.\n\n" +
                        "Please run `pnpm changeset` and commit the generated file under `.changeset/`.\n\n" +
                        "➡️ Maintainers can bypass this check by adding the `no-changeset-needed` label.\n" +
                        "ℹ️ PRs titled with `chore:` or `docs:` also skip this check automatically."
                });
              }
            } else {
              for (const comment of botComments) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}
