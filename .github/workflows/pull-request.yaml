name: Pull Request

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  check-changesets:
    runs-on: ubuntu-latest
    name: üõ°Ô∏è Check Changesets
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changeset
        id: check_changeset
        run: |
          labels="${{ toJson(github.event.pull_request.labels) }}"
          title="${{ github.event.pull_request.title }}"

          # 1. Bypass si existe la etiqueta
          if echo "$labels" | grep -q '"name": *"no-changeset-needed"'; then
          echo "status=bypass" >> $GITHUB_OUTPUT
          echo "‚è© Bypass: Label found."
          exit 0
          fi

          # 2. Bypass si el t√≠tulo es chore o docs
          if echo "$title" | grep -Eiq '^(chore|docs)'; then
          echo "status=bypass" >> $GITHUB_OUTPUT
          echo "‚è© Bypass: Title is chore/docs."
          exit 0
          fi

          # 3. Buscar archivo .changeset
          # Nota: Ajustado para asegurar que comparamos correctamente las ramas
          git fetch origin ${{ github.base_ref }}
          if git diff --name-only origin/${{ github.base_ref }} | grep -q '^.changeset/.*\.md$'; then
          echo "‚úÖ Changeset found."
          echo "status=found" >> $GITHUB_OUTPUT
          else
          echo "‚ùå Changeset missing."
          echo "status=missing" >> $GITHUB_OUTPUT
          # No hacemos exit 1 aqu√≠ todav√≠a para permitir que el paso del comentario se ejecute
          fi

          - name: Manage PR comment
            if: always() # Se ejecuta siempre, incluso si fall√≥ el paso anterior (aunque aqu√≠ controlamos el fallo manualmente)
            uses: actions/github-script@v7
            with:
              script: |
                const status = "${{ steps.check_changeset.outputs.status }}";
                const issue_number = context.issue.number;

                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number,
                });

                const botComments = comments.filter(c =>
                  c.user.type === "Bot" &&
                  c.body.includes("This PR is missing a **Changeset**")
                );

                if (status === "missing") {
                  if (botComments.length === 0) {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number,
                      body: "‚ö†Ô∏è This PR is missing a **Changeset**.\n\n" +
                            "Please run `pnpm changeset` and commit the generated file under `.changeset/`.\n\n" +
                            "‚û°Ô∏è Maintainers can bypass this check by adding the `no-changeset-needed` label.\n" +
                            "‚ÑπÔ∏è PRs titled with `chore:` or `docs:` also skip this check automatically."
                    });
                  }
                  // Hacemos fallar el job AHORA, despu√©s de comentar
                  core.setFailed("Changeset missing");
                } else {
                  // Si ya existe o bypass, borramos el comentario del bot si existe
                  for (const comment of botComments) {
                    await github.rest.issues.deleteComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: comment.id,
                    });
                  }
                }
              github-token: ${{ secrets.GITHUB_TOKEN }}
